[phases.setup]
nixPkgs = ["nodePackages.npm", "gcc", "openssl", "pkg-config", "curl"]

[phases.build]
cmds = [
    # 1. Rustを最新の安定版(1.85)に更新
    "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y",
    ". $HOME/.cargo/env && rustup default stable",
    # 2. 未来の Rust を要求してしまうライブラリを、今動くバージョンに強制ダウングレード
    ". $HOME/.cargo/env && cd rust-engine/nurunuru-napi && cargo update -p home --precise 0.5.9 && cargo update -p napi-build --precise 2.1.3",
    # 3. ビルド実行
    ". $HOME/.cargo/env && cd rust-engine/nurunuru-napi && cargo build --release",
    "mkdir -p rust-engine/nurunuru-napi",
    "cp target/release/libnurunuru_napi.so rust-engine/nurunuru-napi/nurunuru-napi.node || cp target/release/nurunuru_napi.node rust-engine/nurunuru-napi/nurunuru-napi.node",
    "npm install",
    "npm run build"
]

[start]
cmd = "npm run start"
