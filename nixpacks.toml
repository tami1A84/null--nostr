[phases.setup]
nixPkgs = ["nodePackages.npm", "gcc", "openssl", "pkg-config", "curl"]

[phases.build]
cmds = [
    # Rustの準備
    "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y",
    ". $HOME/.cargo/env && rustup default stable",
    
    # ライブラリのバージョン固定とビルド
    ". $HOME/.cargo/env && cd rust-engine/nurunuru-napi && cargo update -p home --precise 0.5.9 && cargo update -p napi-build --precise 2.1.3",
    ". $HOME/.cargo/env && cd rust-engine/nurunuru-napi && cargo build --release",
    
    # 成果物（.nodeファイル）のコピー。正しい相対パスを指定します
    "mkdir -p rust-engine/nurunuru-napi",
    "cp target/release/libnurunuru_napi.so rust-engine/nurunuru-napi/nurunuru-napi.node || cp target/release/nurunuru_napi.node rust-engine/nurunuru-napi/nurunuru-napi.node || cp rust-engine/target/release/libnurunuru_napi.so rust-engine/nurunuru-napi/nurunuru-napi.node || cp rust-engine/target/release/nurunuru_napi.node rust-engine/nurunuru-napi/nurunuru-napi.node",
    
    # Node.js 本体のビルド
    "npm install",
    "npm run build"
]

[start]
cmd = "npm run start"
