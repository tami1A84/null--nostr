[phases.setup]
# Rust コンパイラと、Nostr（OpenSSL等）のビルドに必要なツールをすべて入れます
nixPkgs = ["nodePackages.npm", "gcc", "rustc", "cargo", "openssl", "pkg-config"]

[phases.build]
# 1. まず Rust エンジンをビルドして .node ファイルを生成
# 2. その後 Next.js をビルド
cmds = [
    "cd rust-engine/nurunuru-napi && cargo build --release",
    "mkdir -p rust-engine/nurunuru-napi",
    "cp ../../target/release/libnurunuru_napi.so ./nurunuru-napi.node || cp ../../target/release/nurunuru_napi.node ./nurunuru-napi.node",
    "npm install",
    "npm run build"
]

[start]
cmd = "npm run start"
